<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de producción</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 0; }
    .container { max-width: 420px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(25, 118, 210, 0.10); padding: 24px 18px; }
    h2 { text-align: center; color: #1976d2; font-size: 1.2em; margin-bottom: 18px; }
    .menu { display: flex; justify-content: space-between; margin-bottom: 18px; }
    .menu button { flex: 1; padding: 10px 0; margin: 0 4px; background: #e3f0ff; color: #1976d2; border: none; border-radius: 7px 7px 0 0; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .menu button.active { background: #1976d2; color: #fff; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    form label { display: block; margin-top: 14px; color: #22304a; font-weight: 500; }
    input, select { width: 100%; box-sizing: border-box; padding: 12px; margin-top: 4px; font-size: 1em; border: 1.2px solid #b0b8c9; border-radius: 7px; background: #f4f7fa; }
    .horario-row {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }
    .horario-row input[type="time"] {
      flex: 1 1 0;
      min-width: 0;
      max-width: 204px;
    }
    #idlote-container {
      margin-top: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #idlote-container label {
      font-weight: 600;
      color: #169721; /* color del ID de lote */
      margin-top: 0;
      margin-bottom: 0;
    }
    #idlote {
      flex: 1;
      background: #ffffff;
      width: 100;
      display: inline-block;
      border: 1.5px solid #00000000;
      box-sizing: border-box;
      text-align: left;
      color: #169721; /* color del ID de lote */
    }
  </style>
</head>
<body>
  <div id="modal-cilindros" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(33,40,60,0.18);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:28px 22px 18px 22px;border-radius:12px;box-shadow:0 2px 16px rgba(25,118,210,0.13);max-width:320px;width:90vw;text-align:center;">
      <div id="modal-cilindros-titulo" style="font-weight:600;color:#1976d2;margin-bottom:12px;font-size:1.08em;">Validar cilindros</div>
      <input id="modal-cilindros-input" type="number" inputmode="numeric" pattern="[0-9]*" min="0" style="width:100%;padding:10px;font-size:1.1em;margin-bottom:14px;border:1.2px solid #b0b8c9;border-radius:7px;" placeholder="Cantidad de cilindros">
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="modal-cilindros-ok" style="background:#1976d2;color:#fff;border:none;border-radius:7px;padding:8px 18px;font-size:1em;font-weight:600;cursor:pointer;">Aceptar</button>
        <button id="modal-cilindros-cancel" style="background:#e3f0ff;color:#1976d2;border:1.5px solid #1976d2;border-radius:7px;padding:8px 18px;font-size:1em;font-weight:600;cursor:pointer;">Cancelar</button>
      </div>
    </div>
  </div>
  <div class="container">
    <h2 style="display:flex;align-items:center;justify-content:center;gap:8px;">
      <span style="font-size:1.3em;">&#x1F4DD;</span>
      Registro de producción
    </h2>
    <div class="menu">
      <button type="button" class="active" id="btnLlenador">Datos del llenador</button>
      <button type="button" id="btnLote">Datos del lote</button>
      <button type="button" id="btnProducto">Datos del producto</button>
    </div>
    <div id="sectionLlenador" class="form-section active">
      <form>
        <label>Nombre:
          <input type="text" name="nombre" required list="nombres-lista">
          <datalist id="nombres-lista">
            <option value="Christian Molina">
            <option value="Daniel Hernández">
            <option value="David Oliva">
            <option value="Edgar López">
            <option value="Edson Gonzalez">
            <option value="Fernando Moreno">
            <option value="Francisco López">
            <option value="Francisco Mendoza">
            <option value="Gabriel Martinez">
            <option value="Heriberto Hernández">
            <option value="Humberto Huerta">
            <option value="Jorge Barrón">
            <option value="Jorge Tirado">
            <option value="Jose Jasso">
            <option value="Jose Rodelo">
            <option value="Luis López">
            <option value="Misael Avilés">
            <option value="Misael Palafox">
            <option value="Orlando Ibarra">
            <option value="Rodolfo Villarreal">
            <option value="Samai Acosta">
          </datalist>
        </label>
        <label>Turno:
          <select name="turno" required>
            <option value="">Selecciona</option>
            <option value="Mañana">Mañana</option>
            <option value="Tarde">Tarde</option>
            <option value="Noche">Noche</option>
          </select>
        </label>
        <label>Área:
          <select name="area" required>
            <option value="">Selecciona</option>
            <option value="151 Oxígeno medicinal">151 Oxígeno medicinal</option>
            <option value="211 Oxígeno industrial">211 Oxígeno industrial</option>
            <option value="212 Nitrógeno">212 Nitrógeno</option>
            <option value="213 Bióxido de carbono">213 Bióxido de carbono</option>
            <option value="214 Argón">214 Argón</option>
            <option value="216 Hidrógeno">216 Hidrógeno</option>
            <option value="217 Helio">217 Helio</option>
            <option value="517 Helio líquido">517 Helio líquido</option>
            <option value="Mezclas">Mezclas</option>
          </select>
        </label>
      </form>
    </div>
    <div id="sectionLote" class="form-section">
      <form>
        <label>Número de Manifold:</label>
          <select name="manifold" required>
            <option value="">Selecciona</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </label>
        <label>Número de Línea:</label>
          <select name="linea" required>
            <option value="">Selecciona</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </label>
        <label>Horario inicial y final:</label>
        <div class="horario-row">
          <input type="time" name="horainicial" required>
          <input type="time" name="horafinal" required>
        </div>
      </form>
    </div>
    <div id="sectionProducto" class="form-section">
      <form>
        <label>Código:</label>
          <input type="number" name="codigo" inputmode="numeric" pattern="[0-9]*">
        </label>
        <label>Producto:</label>
          <input type="text" name="producto">
        </label>
        <label>Cilindros:</label>
          <input type="number" name="cilindros" min="1" inputmode="numeric" pattern="[0-9]*">
        </label>
      </form>
    </div>
    <div id="idlote-container">
      <label>Id lote:</label>
        <input type="text" id="idlote" name="idlote" readonly required>
      </label>
    </div>
    <button type="button" id="registrarBtn" style="width:100%;margin-top:18px;background:#1976d2;color:#fff;border:none;border-radius:7px;padding:12px 0;font-size:1em;font-weight:600;cursor:pointer;">Registrar</button>
    <button type="button" id="nuevoRegistroBtn" style="width:100%;margin-top:10px;background:#e3f0ff;color:#1976d2;border:1.5px solid #1976d2;border-radius:7px;padding:10px 0;font-size:1em;font-weight:600;cursor:pointer;">Nuevo registro</button>
    <button type="button" id="verTodosBtn" style="width:100%;margin-top:10px;background:#fff;color:#1976d2;border:1.5px solid #1976d2;border-radius:7px;padding:10px 0;font-size:1em;font-weight:600;cursor:pointer;">Ver todos los lotes</button>
    <div id="todos" style="margin-top:14px;"></div>
    <div id="resumen" style="margin-top:18px;"></div>
  
  </div>
  <script>
    // =============================
    // Generación automática de Id lote
    // =============================
    function actualizarIdLote() {
  // Obtener valores de los campos relevantes
  const codigo = document.querySelector('input[name="codigo"]')?.value || '';
  const turno = document.querySelector('select[name="turno"]')?.value || '';
  const manifold = document.querySelector('select[name="manifold"]')?.value || '';
  const linea = document.querySelector('select[name="linea"]')?.value || '';
  // Fecha actual
  const now = new Date();
  const year = String(now.getFullYear()).slice(-2);
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  // Código de turno a 1 dígito
  let turnoCode = '0';
  if (turno === 'Mañana') turnoCode = '1';
  else if (turno === 'Tarde') turnoCode = '2';
  else if (turno === 'Noche') turnoCode = '3';
  // Manifold y línea a dos dígitos
  const manifoldCode = manifold ? String(manifold).padStart(2, '0') : '00';
  const lineaCode = linea ? String(linea).padStart(2, '0') : '00';
  // Formato final: 425-[codigo]-[año][mes][día]-[manifoldCode]-[turnoCode]-[lineaCode]
  const idlote = `425-${codigo}-${year}${month}${day}-${manifoldCode}-${turnoCode}-${lineaCode}`;
  document.getElementById('idlote').value = idlote;
}

// Asignar eventos a los campos relevantes para actualizar Id lote
document.querySelector('input[name="codigo"]').addEventListener('input', actualizarIdLote);
document.querySelector('select[name="turno"]').addEventListener('change', actualizarIdLote);
document.querySelector('select[name="manifold"]').addEventListener('change', actualizarIdLote);
document.querySelector('select[name="linea"]').addEventListener('change', actualizarIdLote);
// Inicializar al cargar
actualizarIdLote();

// =============================
// Guardar los lotes pendientes en memoria para saber si el idlote es de un lote pendiente
// =============================
let lotesPendientesIds = [];

// =============================
    // Lógica para "Nuevo registro"
    // =============================
    document.getElementById('nuevoRegistroBtn').addEventListener('click', function() {
      // --- MEJORA: Limpiar y desbloquear todos los campos, mostrar sección llenador, ocultar tablas y resumen, enfocar en nombre ---

      // 1. Limpiar todos los campos del formulario
      const camposTodos = [
        'input[name="nombre"]',
        'select[name="turno"]',
        'select[name="area"]',
        'select[name="manifold"]',
        'select[name="linea"]',
        'input[name="horainicial"]',
        'input[name="horafinal"]',
        'input[name="codigo"]',
        'input[name="producto"]',
        'input[name="cilindros"]'
      ];
      camposTodos.forEach(sel => {
        const el = document.querySelector(sel);
        if (el) {
          if (el.tagName === 'SELECT') el.selectedIndex = 0;
          else el.value = '';
        }
      });

      // 2. Desbloquear todos los campos (por si estaban bloqueados tras ver un lote)
      const desbloquear = [
        { selector: 'input[name="nombre"]', prop: 'readOnly' },
        { selector: 'select[name="turno"]', prop: 'disabled' },
        { selector: 'select[name="area"]', prop: 'disabled' },
        { selector: 'select[name="manifold"]', prop: 'disabled' },
        { selector: 'select[name="linea"]', prop: 'disabled' },
        { selector: 'input[name="horainicial"]', prop: 'readOnly' },
        { selector: 'input[name="horafinal"]', prop: 'readOnly' },
        { selector: 'input[name="codigo"]', prop: 'readOnly' },
        { selector: 'input[name="producto"]', prop: 'readOnly' },
        { selector: 'input[name="cilindros"]', prop: 'readOnly' }
      ];
      desbloquear.forEach(c => {
        const el = document.querySelector(c.selector);
        if (el) {
          if (c.prop === 'readOnly') el.readOnly = false;
          if (c.prop === 'disabled') el.disabled = false;
        }
      });

      // 3. Reiniciar Id lote (actualizar según lógica actual)
      const idloteInput = document.getElementById('idlote');
      if (idloteInput) {
        idloteInput.readOnly = true;
        if (typeof actualizarIdLote === 'function') actualizarIdLote();
      }

      // 4. Ocultar resumen
      document.getElementById('resumen').innerHTML = '';

      // 5. Ocultar/reiniciar tabla de lotes
      document.getElementById('todos').innerHTML = '';

      // 6. Mostrar sección Datos del llenador y ocultar las otras
      const sectionLlenador = document.getElementById('sectionLlenador');
      const sectionLote = document.getElementById('sectionLote');
      const sectionProducto = document.getElementById('sectionProducto');
      if (sectionLlenador && sectionLote && sectionProducto) {
        sectionLlenador.classList.add('active');
        sectionLote.classList.remove('active');
        sectionProducto.classList.remove('active');
      }

      // 7. Actualizar menú visual para marcar llenador como activo
      const btnLlenador = document.getElementById('btnLlenador');
      const btnLote = document.getElementById('btnLote');
      const btnProducto = document.getElementById('btnProducto');
      if (btnLlenador && btnLote && btnProducto) {
        btnLlenador.classList.add('active');
        btnLote.classList.remove('active');
        btnProducto.classList.remove('active');
      }

      // 8. Poner el foco en el campo nombre
      const nombre = document.querySelector('input[name="nombre"]');
      if (nombre) nombre.focus();
    });
  
    // =============================
    // Registrar lote y mostrar resumen
    // =============================
  
    document.getElementById('registrarBtn').addEventListener('click', function() {
  // Obtener valores de todos los campos en el orden solicitado
  const idlote = document.getElementById('idlote').value;
  const nombre = document.querySelector('input[name="nombre"]').value;
  const turno = document.querySelector('select[name="turno"]').value;
  const area = document.querySelector('select[name="area"]').value;
  const manifold = document.querySelector('select[name="manifold"]').value;
  const linea = document.querySelector('select[name="linea"]').value;
  const codigo = document.querySelector('input[name="codigo"]').value;
  const producto = document.querySelector('input[name="producto"]').value;
  const cilindros = document.querySelector('input[name="cilindros"]').value;
  function toTimeValue(val) {
    if (!val) return '';
    if (/^\d{2}:\d{2}$/.test(val)) return val;
    if (/^\d{2}:\d{2}:\d{2}$/.test(val)) return val.slice(0,5);
    if (/^\d{4}$/.test(val)) return val.slice(0,2)+":"+val.slice(2,4);
    const ampmMatch = val.match(/^([0-9]{1,2}):(\d{2})\s*([ap]\.\?\s*m\.?)/i);
    if (ampmMatch) {
      let hour = parseInt(ampmMatch[1], 10);
      const min = ampmMatch[2];
      const ampm = ampmMatch[3].toLowerCase();
      if (ampm.includes('p') && hour < 12) hour += 12;
      if (ampm.includes('a') && hour === 12) hour = 0;
      return (hour < 10 ? '0' : '') + hour + ':' + min;
    }
    return '';
  }
  const horainicial = toTimeValue(document.querySelector('input[name="horainicial"]').value);
  const horafinal = toTimeValue(document.querySelector('input[name="horafinal"]').value);

  // Validación: Todos los campos son obligatorios, incluyendo horas.
  if (
    !idlote ||
    !nombre ||
    !turno ||
    !area ||
    !manifold ||
    !linea ||
    !codigo ||
    !producto ||
    !cilindros ||
    !horainicial ||
    !horafinal
  ) {
    document.getElementById('resumen').innerHTML = '<span style="color:#d32f2f;">Por favor, completa todos los campos obligatorios antes de registrar.</span>';
    return;
  }

  // Validar Id lote contra Google Sheets antes de enviar
  fetch('https://script.google.com/macros/s/AKfycbxzK-xJaggLLaNy7i2g5g--iTX-LX9qLb2WMg8uUFIDqVVzqAtYtL2Ag8OBSQ98N6AM/exec')
    .then(resp => resp.json())
    .then(function(lotes) {
      // Si la respuesta es un array de objetos, extraer los Id lote
      let idLotesArray = [];
      if (Array.isArray(lotes) && lotes.length > 0 && typeof lotes[0] === 'object') {
        idLotesArray = lotes.map(l => l['Id lote']);
      } else if (Array.isArray(lotes)) {
        idLotesArray = lotes;
      }
      if (idLotesArray.includes(idlote)) {
        document.getElementById('resumen').innerHTML = "<div style='background:#fff3e0;border:1.5px solid #ffa726;border-radius:9px;box-shadow:0 2px 8px rgba(255,167,38,0.08);padding:14px 18px;color:#f57c00;font-size:1.08em;font-weight:500;text-align:left;margin-top:10px;'>Id lote duplicado favor de validar.</div>";
        return;
      }

      // Mostrar resumen solo si el Id lote no está duplicado
      const resumen = `<b>Resumen del registro:</b><br>` +
        `Id lote: ${idlote}<br>` +
        `Nombre: ${nombre}<br>` +
        `Turno: ${turno}<br>` +
        `Área: ${area}<br>` +
        `Número Manifold: ${manifold}<br>` +
        `Número Línea: ${linea}<br>` +
        `Hora inicial: ${horainicial}<br>` +
        `Hora final: ${horafinal}<br>` +
        `Código: ${codigo}<br>` +
        `Producto: ${producto}<br>` +
        `Cilindros: ${cilindros}`;
      document.getElementById('resumen').innerHTML = `<div style='background:#f5faff;border:1.5px solid #b6c6e3;border-radius:9px;box-shadow:0 2px 8px rgba(25,118,210,0.06);padding:14px 18px;color:#1976d2;font-size:1.08em;font-weight:500;text-align:left;'>${resumen}</div>` +
        `<div style='margin-top:14px;display:flex;gap:10px;justify-content:center;'>` +
        `<button id='confirmarEnvioBtn' style='background:#1976d2;color:#fff;border:none;border-radius:7px;padding:10px 22px;font-size:1em;font-weight:600;cursor:pointer;'>Confirmar y enviar</button>` +
        `<button id='editarEnvioBtn' style='background:#fff;color:#1976d2;border:1.5px solid #1976d2;border-radius:7px;padding:10px 22px;font-size:1em;font-weight:600;cursor:pointer;'>Editar</button>` +
        `</div>`;

      // Botón Editar: regresa a la sección de llenador y permite editar
      setTimeout(function() {
        document.getElementById('editarEnvioBtn').onclick = function() {
          // Limpiar el área de resumen para ocultar el resumen y los botones
          document.getElementById('resumen').innerHTML = '';
          // Mostrar sección Datos del llenador y ocultar las otras
          const sectionLlenador = document.getElementById('sectionLlenador');
          const sectionLote = document.getElementById('sectionLote');
          const sectionProducto = document.getElementById('sectionProducto');
          if (sectionLlenador && sectionLote && sectionProducto) {
            sectionLlenador.classList.add('active');
            sectionLote.classList.remove('active');
            sectionProducto.classList.remove('active');
          }
          // Actualizar menú visual
          const btnLlenador = document.getElementById('btnLlenador');
          const btnLote = document.getElementById('btnLote');
          const btnProducto = document.getElementById('btnProducto');
          if (btnLlenador && btnLote && btnProducto) {
            btnLlenador.classList.add('active');
            btnLote.classList.remove('active');
            btnProducto.classList.remove('active');
          }
          // Poner el foco en el campo nombre
          const nombre = document.querySelector('input[name="nombre"]');
          if (nombre) nombre.focus();
        };
        // Botón Confirmar y enviar: envía a Sheets
        document.getElementById('confirmarEnvioBtn').onclick = function() {
          // Limpiar los campos de Datos de lote y Datos del producto
          document.querySelector('select[name="manifold"]').selectedIndex = 0;
          document.querySelector('select[name="linea"]').selectedIndex = 0;
          document.querySelector('input[name="horainicial"]').value = '';
          document.querySelector('input[name="horafinal"]').value = '';
          document.querySelector('input[name="codigo"]').value = '';
          document.querySelector('input[name="producto"]').value = '';
          document.querySelector('input[name="cilindros"]').value = '';

          // Mostrar sección Datos del lote y ocultar las otras
          const sectionLote = document.getElementById('sectionLote');
          const sectionLlenador = document.getElementById('sectionLlenador');
          const sectionProducto = document.getElementById('sectionProducto');
          if (sectionLote && sectionLlenador && sectionProducto) {
            sectionLote.classList.add('active');
            sectionLlenador.classList.remove('active');
            sectionProducto.classList.remove('active');
          }
          // Actualizar menú visual
          const btnLote = document.getElementById('btnLote');
          const btnLlenador = document.getElementById('btnLlenador');
          const btnProducto = document.getElementById('btnProducto');
          if (btnLote && btnLlenador && btnProducto) {
            btnLote.classList.add('active');
            btnLlenador.classList.remove('active');
            btnProducto.classList.remove('active');
          }
          
          // Enviar datos a Google Sheets vía Apps Script
          const data = {
            idlote,
            nombre,
            turno,
            area,
            manifold,
            linea,
            horainicial,
            horafinal,
            codigo,
            producto,
            cilindros
          };
          fetch('https://script.google.com/macros/s/AKfycbxzK-xJaggLLaNy7i2g5g--iTX-LX9qLb2WMg8uUFIDqVVzqAtYtL2Ag8OBSQ98N6AM/exec', {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
          .then(function() {
            // Mostrar mensaje de éxito tras confirmar
            document.getElementById('resumen').innerHTML = `<div style='background:#e8f5e9;border:1.5px solid #43a047;border-radius:9px;box-shadow:0 2px 8px rgba(67,160,71,0.08);padding:14px 18px;color:#388e3c;font-size:1.08em;font-weight:500;text-align:left;'>✅ Registro completado. Puedes ingresar un nuevo lote.</div>`;
          })
          .catch(function() {
            document.getElementById('resumen').innerHTML += `<div style='background:#ffebee;border:1.5px solid #d32f2f;border-radius:9px;box-shadow:0 2px 8px rgba(211,47,47,0.08);padding:14px 18px;color:#c62828;font-size:1.08em;font-weight:500;text-align:left;margin-top:10px;'>❌ No se pudo registrar el lote. Intenta nuevamente.</div>`;
          });
        };
      }, 0);
    })
    .catch(() => {
      document.getElementById('resumen').innerHTML += `<div style='background:#ffebee;border:1.5px solid #d32f2f;border-radius:9px;box-shadow:0 2px 8px rgba(211,47,47,0.08);padding:14px 18px;color:#c62828;font-size:1.08em;font-weight:500;text-align:left;margin-top:10px;'>❌ No se pudo validar el Id lote en Google Sheets.</div>`;
    });
});
    // =============================
    // Mostrar tabla de todos los lotes (independientemente del estado)
    // =============================
    document.getElementById('verTodosBtn').addEventListener('click', function() {
      const todosDiv = document.getElementById('todos');
      todosDiv.innerHTML = '<span style="color:#1976d2;">Cargando todos los lotes...</span>';
      fetch('https://script.google.com/macros/s/AKfycbxzK-xJaggLLaNy7i2g5g--iTX-LX9qLb2WMg8uUFIDqVVzqAtYtL2Ag8OBSQ98N6AM/exec')
        .then(resp => resp.json())
        .then(lotes => {
          if (!Array.isArray(lotes) || lotes.length === 0) {
            todosDiv.innerHTML = '<span style="color:#d32f2f;">No hay lotes registrados.</span>';
            return;
          }
          let tabla = `<table style='width:100%;border-collapse:collapse;font-size:0.98em;'>`;
          tabla += `<tr style='background:#e3f0ff;color:#1976d2;'><th style='border:1px solid #b6c6e3;padding:4px;'>Id lote</th><th style='border:1px solid #b6c6e3;padding:4px;'>Estado</th><th style='border:1px solid #b6c6e3;padding:4px;'>Acción</th></tr>`;
          lotes.forEach((lote, idx) => {
            const idLoteValue = lote['Id lote'] || '';
            const estadoValue = (lote['Estado'] || '').toLowerCase();
            let color = '#1976d2';
            let bg = '#f5faff';
            if (estadoValue === 'rechazado') { color = '#d32f2f'; bg = '#ffebee'; }
            else if (estadoValue === 'validado') { color = '#388e3c'; bg = '#e8f5e9'; }
            else if (estadoValue === 'pendiente') { color = '#1976d2'; bg = '#f5faff'; }
            tabla += `<tr>` +
              `<td style='border:1px solid #b6c6e3;padding:4px;'>${idLoteValue}</td>` +
              `<td style='border:1px solid #b6c6e3;padding:4px;color:${color};background:${bg};font-weight:600;'>${lote['Estado'] || ''}</td>` +
              `<td style='border:1px solid #b6c6e3;padding:4px;'>
                <button type='button' class='ver-resumen-todos-btn' data-idx='${idx}' title='Ver resumen' style='background:none;border:none;cursor:pointer;font-size:1.2em;color:${color};'>
                  <span style='font-size:1.3em;'>&#x1F50D;</span>
                </button>
              </td>` +
            `</tr>`;
          });
          tabla += `</table>`;
          todosDiv.innerHTML = tabla;

          // Asignar evento a los botones 'Ver resumen' de todos los lotes
          document.querySelectorAll('.ver-resumen-todos-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const lote = lotes[parseInt(this.getAttribute('data-idx'))];
              if (!lote) return;
              // Cargar los datos del lote en el formulario principal y bloquear los campos
              document.getElementById('idlote').value = lote['Id lote'] || '';
              document.getElementById('idlote').readOnly = true;
              const campos = [
                { selector: 'input[name="nombre"]', value: lote['Nombre'] || '', prop: 'readOnly' },
                { selector: 'select[name="turno"]', value: lote['Turno'] || '', prop: 'disabled' },
                { selector: 'input[name="area"]', value: lote['Área'] || '', prop: 'readOnly' },
                { selector: 'input[name="manifold"]', value: lote['Manifold'] || '', prop: 'readOnly' },
                { selector: 'input[name="linea"]', value: lote['Línea'] || '', prop: 'readOnly' },
                { selector: 'input[name="horainicial"]', value: lote['Hora inicial'] || '', prop: 'readOnly' },
                { selector: 'input[name="horafinal"]', value: lote['Hora final'] || '', prop: 'readOnly' },
                { selector: 'input[name="codigo"]', value: lote['Código'] || '', prop: 'readOnly' },
                { selector: 'input[name="producto"]', value: lote['Producto'] || '', prop: 'readOnly' },
                { selector: 'input[name="cilindros"]', value: lote['Cilindros'] || '', prop: 'readOnly' }
              ];
              campos.forEach(c => {
                const el = document.querySelector(c.selector);
                if (el) {
                  el.value = c.value;
                  if (c.prop === 'readOnly') el.readOnly = true;
                  if (c.prop === 'disabled') el.disabled = true;
                }
              });
              // Mostrar resumen igual que al registrar, pero con color según estado
              const idlote = lote['Id lote'] || '';
              const nombre = lote['Nombre'] || '';
              const turno = lote['Turno'] || '';
              const area = lote['Área'] || '';
              const manifold = lote['Manifold'] || '';
              const linea = lote['Línea'] || '';
              function toTimeValue(val) {
                if (!val) return '';
                const isoMatch = val.match(/T(\d{2}):(\d{2})/);
                if (isoMatch) return isoMatch[1] + ':' + isoMatch[2];
                if (/^\d{2}:\d{2}$/.test(val)) return val;
                if (/^\d{2}:\d{2}:\d{2}$/.test(val)) return val.slice(0,5);
                if (/^\d{4}$/.test(val)) return val.slice(0,2)+":"+val.slice(2,4);
                const ampmMatch = val.match(/^(\d{1,2}):(\d{2})\s*([ap]\.\?\s*m\.?)/i);
                if (ampmMatch) {
                  let hour = parseInt(ampmMatch[1], 10);
                  const min = ampmMatch[2];
                  const ampm = ampmMatch[3].toLowerCase();
                  if (ampm.includes('p') && hour < 12) hour += 12;
                  if (ampm.includes('a') && hour === 12) hour = 0;
                  return (hour < 10 ? '0' : '') + hour + ':' + min;
                }
                return val;
              }
              const horainicial = toTimeValue(lote['Hora inicial'] || '');
              const horafinal = toTimeValue(lote['Hora final'] || '');
              const codigo = lote['Código'] || '';
              const producto = lote['Producto'] || '';
              const cilindros = lote['Cilindros'] || '';
              const estadoValue = (lote['Estado'] || '').toLowerCase();
              let color = '#1976d2';
              let bg = '#f5faff';
              let border = '#b6c6e3';
              if (estadoValue === 'rechazado') { color = '#d32f2f'; bg = '#ffebee'; border = '#d32f2f'; }
              else if (estadoValue === 'validado') { color = '#388e3c'; bg = '#e8f5e9'; border = '#43a047'; }
              else if (estadoValue === 'pendiente') { color = '#1976d2'; bg = '#f5faff'; border = '#1976d2'; }
              const resumen = `<b>Resumen del registro:</b><br>` +
                `Id lote: ${idlote}<br>` +
                `Nombre: ${nombre}<br>` +
                `Turno: ${turno}<br>` +
                `Área: ${area}<br>` +
                `Número Manifold: ${manifold}<br>` +
                `Número Línea: ${linea}<br>` +
                `Hora inicial: ${horainicial}<br>` +
                `Hora final: ${horafinal}<br>` +
                `Código: ${codigo}<br>` +
                `Producto: ${producto}<br>` +
                `Cilindros: ${cilindros}`;
              let resumenHtml = `<div style='background:${bg};border:1.5px solid ${border};border-radius:9px;box-shadow:0 2px 8px ${color}22;padding:14px 18px;color:${color};font-size:1.08em;font-weight:500;text-align:left;'>${resumen}`;
              // Si el lote es pendiente, agregar botón para validar
              if (estadoValue === 'pendiente') {
                resumenHtml += `<div style='margin-top:14px;display:flex;gap:10px;justify-content:center;'>` +
                  `<button id='validarDesdeResumenBtn' style='background:#ff9800;color:#fff;border:none;border-radius:7px;padding:10px 22px;font-size:1em;font-weight:600;cursor:pointer;'>Validar lote</button>` +
                `</div>`;
              }
              // Si el lote es rechazado, agregar botón para modificar cilindros y validar
              if (estadoValue === 'rechazado') {
                resumenHtml += `<div style='margin-top:14px;display:flex;gap:10px;justify-content:center;'>` +
                  `<button id='modificarCilindrosDesdeResumenBtn' style='background:#1976d2;color:#fff;border:none;border-radius:7px;padding:10px 22px;font-size:1em;font-weight:600;cursor:pointer;'>Ingresar cantidad correcta</button>` +
                `</div>`;
              }
              resumenHtml += `</div>`;
              document.getElementById('resumen').innerHTML = resumenHtml;
              // Evento para validar desde el resumen
              if (estadoValue === 'pendiente') {
                setTimeout(function() {
                  const btnValidar = document.getElementById('validarDesdeResumenBtn');
                  if (btnValidar) {
                    btnValidar.onclick = function() {
                      // Abrir modal para validar cilindros
                      const modal = document.getElementById('modal-cilindros');
                      const input = document.getElementById('modal-cilindros-input');
                      const titulo = document.getElementById('modal-cilindros-titulo');
                      modal.style.display = 'flex';
                      input.value = '';
                      input.focus();
                      titulo.textContent = `Valide la cantidad de cilindros del lote: ${idlote}`;
                      // Función para cerrar modal
                      function cerrarModal() {
                        modal.style.display = 'none';
                        input.value = '';
                        document.getElementById('modal-cilindros-ok').onclick = null;
                        document.getElementById('modal-cilindros-cancel').onclick = null;
                      }
                      document.getElementById('modal-cilindros-cancel').onclick = cerrarModal;
                      document.getElementById('modal-cilindros-ok').onclick = function() {
                        const cilindrosIngresados = input.value.trim();
                        if (!/^[0-9]+$/.test(cilindrosIngresados)) {
                          alert('Por favor, ingrese un número válido.');
                          input.focus();
                          return;
                        }
                        let estado = '';
                        let mensaje = '';
                        // Comparación robusta: elimina espacios y compara como números
                        const valIngresado = parseInt(cilindrosIngresados.trim(), 10);
                        const valRegistrado = parseInt((cilindros || '').toString().trim(), 10);
                        if (!isNaN(valIngresado) && !isNaN(valRegistrado) && valIngresado === valRegistrado) {
                          estado = 'Validado';
                          mensaje = `✔️ El lote <b>${idlote}</b> ha sido validado correctamente. La cantidad de cilindros ingresada (<b>${cilindrosIngresados}</b>) coincide con la registrada en el sistema.`;
                        } else {
                          estado = 'Rechazado';
                          mensaje = `❌ El lote <b>${idlote}</b> ha sido rechazado. La cantidad de cilindros ingresada (<b>${cilindrosIngresados}</b>) <b>NO coincide</b> con la registrada (<b>${cilindros}</b>). Por favor, verifique los datos.`;
                        }
                        document.getElementById('resumen').innerHTML = `<div style='background:${estado === 'Validado' ? '#e8f5e9' : '#ffebee'};border:1.5px solid ${estado === 'Validado' ? '#43a047' : '#d32f2f'};border-radius:9px;box-shadow:0 2px 8px rgba(67,160,71,0.08);padding:14px 18px;color:${estado === 'Validado' ? '#388e3c' : '#c62828'};font-size:1.08em;font-weight:500;text-align:left;'>${mensaje}</div>`;
                        fetch('https://script.google.com/macros/s/AKfycbxzK-xJaggLLaNy7i2g5g--iTX-LX9qLb2WMg8uUFIDqVVzqAtYtL2Ag8OBSQ98N6AM/exec', {
                          method: 'POST',
                          mode: 'no-cors',
                          headers: {
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({ idlote, estadoValidacion: estado })
                        });
                        cerrarModal();
                      };
                    };
                  }
                }, 0);
              }
              // Evento para modificar cilindros y validar desde el resumen de rechazados
              if (estadoValue === 'rechazado') {
                setTimeout(function() {
                  const btnModificar = document.getElementById('modificarCilindrosDesdeResumenBtn');
                  if (btnModificar) {
                    btnModificar.onclick = function() {
                      // Abrir modal para ingresar cantidad correcta
                      const modal = document.getElementById('modal-cilindros');
                      const input = document.getElementById('modal-cilindros-input');
                      const titulo = document.getElementById('modal-cilindros-titulo');
                      modal.style.display = 'flex';
                      input.value = '';
                      input.focus();
                      titulo.textContent = `Ingresa la cantidad correcta de cilindros del lote ${idlote}`;
                      // Función para cerrar modal
                      function cerrarModal() {
                        modal.style.display = 'none';
                        input.value = '';
                        document.getElementById('modal-cilindros-ok').onclick = null;
                        document.getElementById('modal-cilindros-cancel').onclick = null;
                      }
                      document.getElementById('modal-cilindros-cancel').onclick = cerrarModal;
                      document.getElementById('modal-cilindros-ok').onclick = function() {
                        const cilindrosIngresados = input.value.trim();
                        if (!/^[0-9]+$/.test(cilindrosIngresados)) {
                          alert('Por favor, ingrese un número válido.');
                          input.focus();
                          return;
                        }
                        // Aquí el lote pasa a validado, se actualiza en Sheets y se muestra mensaje
                        fetch('https://script.google.com/macros/s/AKfycbxzK-xJaggLLaNy7i2g5g--iTX-LX9qLb2WMg8uUFIDqVVzqAtYtL2Ag8OBSQ98N6AM/exec', {
                          method: 'POST',
                          mode: 'no-cors',
                          headers: {
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({ idlote, Cilindros: cilindrosIngresados, estadoValidacion: 'Validado' })
                        });
                        document.getElementById('resumen').innerHTML = `<div style='background:#e8f5e9;border:1.5px solid #43a047;border-radius:9px;box-shadow:0 2px 8px rgba(67,160,71,0.08);padding:14px 18px;color:#388e3c;font-size:1.08em;font-weight:500;text-align:left;'>✔️ El lote <b>${idlote}</b> ha sido validado y la cantidad de cilindros actualizada a <b>${cilindrosIngresados}</b>.</div>`;
                        cerrarModal();
                      };
                    };
                  }
                }, 0);
              }
            });
          });
        })
        .catch(() => {
          todosDiv.innerHTML = '<span style="color:#d32f2f;">No se pudo obtener la lista de lotes.</span>';
        });
    });
    // =============================
    // Lógica para selección de menú
    // =============================
    document.getElementById('btnLlenador').addEventListener('click', function() {
      document.getElementById('sectionLlenador').classList.add('active');
      document.getElementById('sectionLote').classList.remove('active');
      document.getElementById('sectionProducto').classList.remove('active');
      this.classList.add('active');
      document.getElementById('btnLote').classList.remove('active');
      document.getElementById('btnProducto').classList.remove('active');
    });

    document.getElementById('btnLote').addEventListener('click', function() {
      document.getElementById('sectionLote').classList.add('active');
      document.getElementById('sectionLlenador').classList.remove('active');
      document.getElementById('sectionProducto').classList.remove('active');
      this.classList.add('active');
      document.getElementById('btnLlenador').classList.remove('active');
      document.getElementById('btnProducto').classList.remove('active');
    });

    document.getElementById('btnProducto').addEventListener('click', function() {
      document.getElementById('sectionProducto').classList.add('active');
      document.getElementById('sectionLlenador').classList.remove('active');
      document.getElementById('sectionLote').classList.remove('active');
      this.classList.add('active');
      document.getElementById('btnLlenador').classList.remove('active');
      document.getElementById('btnLote').classList.remove('active');
    });
  </script>
</body>
</html>
